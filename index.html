<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç„æœºå…­çˆ» Â· æ·±åº¦æ¨ç®—</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- å…¨å±€ç²¾è‡´ä¸»é¢˜ï¼šç„å¢¨ä¸éé‡‘ --- */
        :root {
            --dark-primary: #1a2a3a; /* ç„å¢¨è“ */
            --accent-gold: #d4af37; /* éé‡‘ */
            --action-red: #c0392b; /* æœ±ç ‚çº¢ */
            --bg-light: #f4f5f9; /* æµ…ç°åº• */
            --card-white: #ffffff;
            --font-serif: 'PingFang SC', 'Songti SC', serif;
        }

        body {
            font-family: var(--font-serif);
            background: var(--bg-light);
            color: var(--dark-primary);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding-top: 30px;
        }

        .app-container {
            width: 100%;
            max-width: 420px; /* é€‚é…æ‰‹æœºå®½åº¦ */
            background: var(--card-white);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 30px 20px;
            margin-bottom: 30px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        /* æ ‡é¢˜è®¾è®¡ */
        header { text-align: center; margin-bottom: 25px; }
        h1 { 
            margin: 0; 
            font-size: 1.8rem; 
            letter-spacing: 2px; 
            color: var(--dark-primary); 
            font-weight: bold;
        }
        h1 span { color: var(--accent-gold); }
        .subtitle { font-size: 0.85rem; color: #888; margin-top: 5px; }

        /* è¾“å…¥æ¡† */
        input[type="text"] {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 25px;
            background: #fcfcfc;
            outline: none;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus { border-color: var(--action-red); box-shadow: 0 0 5px rgba(192, 57, 43, 0.2); }

        /* æŒ‰é’®é£æ ¼ */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-start { background: linear-gradient(45deg, var(--action-red), #8e1419); color: white; }
        .btn-start:active { transform: scale(0.98); }
        .btn-start:disabled { background: #ccc; color: #999; box-shadow: none; cursor: not-allowed; }
        .btn-ai { background: var(--dark-primary); color: var(--accent-gold); margin-top: 15px; }

        /* æ‘‡å¦åŒº */
        .stage { height: 70px; display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .coin {
            width: 45px; height: 45px; border-radius: 50%;
            border: 3px solid var(--accent-gold);
            background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-out;
            animation: flip 0.5s ease-in-out;
        }
        .coin.yin { background: var(--dark-primary); border-color: var(--dark-primary); }

        @keyframes flip {
            0% { transform: scale(0.5) rotateY(0deg); }
            100% { transform: scale(1) rotateY(360deg); }
        }

        /* å†å²è®°å½• */
        .history { margin-top: 20px; display: flex; flex-direction: column-reverse; gap: 8px; }
        .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; }
        .sym { font-family: monospace; font-weight: 900; font-size: 1.2rem; color: var(--dark-primary); }
        .red-dot { color: var(--action-red); margin-left: 5px; font-size: 1.1em; }
        
        /* ç»“æœå¡ç‰‡ UI */
        #shareCard { 
            display: none; 
            margin-top: 30px; 
            padding: 25px; 
            border-radius: 15px; 
            background: linear-gradient(160deg, var(--card-white) 0%, #fff8e1 100%); /* ä¼˜é›…æ¸å˜ */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--accent-gold);
        }
        .card-header { text-align: center; margin-bottom: 20px; }
        .card-header h2 { color: var(--action-red); font-size: 1.5rem; margin: 0; }
        .card-meta { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .card-content { border-top: 1px dashed #ddd; padding-top: 20px; }
        .share-prompt { background: #e8f5e9; color: #388e3c; padding: 12px; border-radius: 10px; font-weight: bold; margin-top: 25px; }

        /* AI è¾“å‡ºæ ¼å¼ä¼˜åŒ– */
        .card-content p { margin-bottom: 1em; line-height: 1.8; }
        .card-content strong { color: var(--dark-primary); }
        .card-content h3 { color: var(--action-red); border-left: 3px solid var(--action-red); padding-left: 10px; margin-top: 1.5em; }

        /* æ’ç›˜ä¿¡æ¯ï¼ˆéšè—åœ¨å¡ç‰‡å†…ï¼Œç®€æ´åŒ–ï¼‰ */
        #baseInfo { background: #fcfcfc; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; line-height: 1.6; }
        
        /* é‡æ–°èµ·å¦æŒ‰é’® */
        .restart-btn { 
            color: var(--dark-primary); 
            background: none; 
            border: none; 
            padding: 10px; 
            margin-top: 20px; 
            font-size: 0.9rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>ç„æœº<span>å…­çˆ»</span></h1>
        <div class="subtitle">æ·±åº¦æ¨ç®— Â· å¾®ä¿¡åˆ†äº«ä¸“ç”¨</div>
    </header>
    
    <script>
        const WORKER_ENDPOINT = "https://t6.tk709054540.workers.dev"; // éƒ¨ç½²åï¼Œè¯·æ›¿æ¢æ­¤åœ°å€ï¼
    </script>
    
    <div id="setupView">
        <input type="text" id="question" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨æƒ³é—®çš„é—®é¢˜ï¼ˆå¿ƒè¯šåˆ™çµï¼‰">
        
        <div class="stage" id="coinStage"><span>å¿ƒå¿µåˆä¸€ï¼Œç‚¹å‡»å¼€å§‹</span></div>
        <button class="btn btn-start" id="tossBtn" onclick="userToss()">å¼€å§‹æ‘‡å¦ (1/6)</button>
        <div class="history" id="historyLog"></div>
    </div>

    <div id="resultView" style="display: none;">
        <div class="info-card" id="baseInfo"></div>
        
        <div id="shareCard">
            <div class="card-header">
                <h2>âœ¨ ã€ç¥æœºè§£è¯­ã€‘ âœ¨</h2>
                <div class="card-meta" id="cardMeta"></div>
            </div>
            <div class="card-content" id="cardContent">
                <div style="text-align:center; color:#999;">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¯·æ±‚ AI è§£è¯»...</div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-ai" id="aiBtn" onclick="callDeepSeek()">ğŸ¤– è¯·æ±‚ AI å¤§å¸ˆè§£å¦</button>
                </div>
            </div>
            <div class="share-prompt">
                é•¿æŒ‰å¡ç‰‡åŒºåŸŸå³å¯ä¿å­˜å›¾ç‰‡ï¼Œåˆ†äº«è‡³æœ‹å‹åœˆæˆ–å¥½å‹ï¼
            </div>
        </div>
        
        <div style="text-align:center;">
            <button class="restart-btn" onclick="location.reload()">é‡æ–°èµ·å¦</button>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® (ä¸å˜) ---
    const CFG = {
        NA_JIA: { 'ä¹¾': {z:['å­','å¯…','è¾°','åˆ','ç”³','æˆŒ']}, 'å¤': {z:['æœª','å·³','å¯','ä¸‘','äº¥','é…‰']}, 'éœ‡': {z:['å­','å¯…','è¾°','åˆ','ç”³','æˆŒ']}, 'å·½': {z:['ä¸‘','äº¥','é…‰','æœª','å·³','å¯']}, 'å': {z:['å¯…','è¾°','åˆ','ç”³','æˆŒ','å­']}, 'ç¦»': {z:['å¯','ä¸‘','äº¥','é…‰','æœª','å·³']}, 'è‰®': {z:['è¾°','åˆ','ç”³','æˆŒ','å­','å¯…']}, 'å…‘': {z:['å·³','å¯','ä¸‘','äº¥','é…‰','æœª']} },
        PALACE: {'ä¹¾':'é‡‘','å…‘':'é‡‘','ç¦»':'ç«','éœ‡':'æœ¨','å·½':'æœ¨','å':'æ°´','è‰®':'åœŸ','å¤':'åœŸ'},
        WUXING_REV: {'å­':'æ°´','äº¥':'æ°´','å¯…':'æœ¨','å¯':'æœ¨','å·³':'ç«','åˆ':'ç«','ç”³':'é‡‘','é…‰':'é‡‘','è¾°':'åœŸ','æˆŒ':'åœŸ','ä¸‘':'åœŸ','æœª':'åœŸ'},
        BEASTS: ['é’é¾™','æœ±é›€','å‹¾é™ˆ','æ»•è›‡','ç™½è™','ç„æ­¦']
    };

    let state = { count: 0, results: [], data: {} };
    
    // --- ä¿®å¤åçš„æ‘‡å¦å‡½æ•°ï¼šå¢åŠ å®¹é”™å’Œç¨³å®šæ€§ ---
    function userToss() {
        try {
            if(state.count >= 6) return;

            // éœ‡åŠ¨åé¦ˆ (å¦‚æœè®¾å¤‡æ”¯æŒ)
            if(navigator.vibrate) navigator.vibrate(50); 

            // æ¨¡æ‹Ÿç¡¬å¸
            let c = [Math.random()>.5?1:0, Math.random()>.5?1:0, Math.random()>.5?1:0];
            let sum = c[0]+c[1]+c[2];
            let val = sum===1?7 : sum===2?8 : sum===3?9 : 6;
            let name = sum===1?"å°‘é˜³": sum===2?"å°‘é˜´": sum===3?"è€é˜³(åŠ¨)":"è€é˜´(åŠ¨)";

            state.results.push(val);
            state.count++;

            // æ¸²æŸ“ç¡¬å¸ (ä½¿ç”¨ç©ºdivè§¦å‘CSSåŠ¨ç”»)
            document.getElementById('coinStage').innerHTML = c.map(y => `<div class="coin ${y?'yin':''}"></div>`).join('');
            
            // æ¸²æŸ“åˆ—è¡¨
            let sym = (val===7||val===9)?"â”â”â”":"â”ã€€â”";
            let mk = (val===6||val===9)?"<span class='red-dot'>â—</span>":"";
            let row = `<div class="row"><span>${state.count}. ${name}</span><span class="sym">${sym} ${mk}</span></div>`;
            document.getElementById('historyLog').insertAdjacentHTML('afterbegin', row);

            let btn = document.getElementById('tossBtn');
            if(state.count < 6) { 
                btn.innerText = `ç»§ç»­æ‘‡å¦ (${state.count+1}/6)`; 
            } else { 
                btn.innerText = "æ­£åœ¨æ’ç›˜..."; 
                btn.disabled = true; 
                setTimeout(calculate, 600); 
            }
        } catch(e) {
            console.error("æ‘‡å¦åŠŸèƒ½å‡ºé”™:", e);
            alert("æ‘‡å¦åŠŸèƒ½æš‚æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–åˆ·æ–°é‡è¯•ã€‚");
        }
    }

    function calculate() {
        document.getElementById('setupView').style.display = 'none';
        document.getElementById('resultView').style.display = 'block';

        let dateStr = "", gzDay = "ç”²å­", dayGan = "ç”²", xunKong = "æœªçŸ¥";
        try { 
            // å°è¯•è·å–å‡†ç¡®æ—¶é—´
            if(typeof Solar === 'undefined') throw new Error("Lib missing");
            const d = Solar.fromDate(new Date()); const l = d.getLunar();
            dateStr = l.getYearInGanZhi() + "å¹´" + l.getMonthInGanZhi() + "æœˆ";
            gzDay = l.getDayInGanZhi(); dayGan = gzDay[0]; xunKong = l.getDayXunKong();
        } catch(e) { 
            dateStr = (new Date()).toLocaleDateString('zh-CN');
            // é™çº§ä½¿ç”¨é»˜è®¤å€¼
        }

        const benBits = state.results.map(r=>(r===7||r===9)?1:0);
        const benInfo = getGuaName(benBits);
        const meEl = CFG.PALACE[benInfo.palace];

        document.getElementById('baseInfo').innerHTML = `
            <strong>æ±‚é—®ï¼š</strong>${document.getElementById('question').value || "æœªæŒ‡å®šé—®é¢˜"}<br>
            <strong>æ—¥æœŸï¼š</strong>${dateStr} / ${gzDay} (${xunKong}ç©º)<br>
            <strong>å¦åï¼š</strong>${benInfo.name} (å±${benInfo.palace}${meEl})
        `;

        // æå–åŠ¨çˆ»ä¿¡æ¯ (ç®€åŒ–ï¼Œä¸»è¦äº¤ç»™AIå¤„ç†)
        const moves = state.results.map((v, i) => (v===6 || v===9) ? `${['åˆ','äºŒ','ä¸‰','å››','äº”','ä¸Š'][i]}çˆ»åŠ¨` : null).filter(Boolean);

        state.data = {
            q: document.getElementById('question').value || "æœªæŒ‡å®šé—®é¢˜", 
            d: dateStr + gzDay, 
            g: benInfo.name, 
            m: moves.join('ï¼›') || "é™å¦"
        };
        
        // æ˜¾ç¤ºå¡ç‰‡å¤´éƒ¨ä¿¡æ¯
        document.getElementById('cardMeta').innerHTML = `æ‰€é—®ï¼š${state.data.q} &nbsp;|&nbsp; å¦è±¡ï¼š${state.data.g}`;
    }

    // --- è°ƒç”¨ DeepSeek Worker Proxy (å…³é”®å‡½æ•°) ---
    async function callDeepSeek() {
        if (WORKER_ENDPOINT.includes("YOUR-WORKER-NAME")) {
             alert("åŠŸèƒ½é”™è¯¯ï¼šè¯·å…ˆéƒ¨ç½² Cloudflare Workerï¼Œå¹¶å°† WORKER_ENDPOINT æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„åœ°å€ï¼");
             return;
        }

        const btn = document.getElementById('aiBtn');
        const out = document.getElementById('cardContent');
        
        btn.disabled = true;
        btn.innerText = "â³ AI æ­£åœ¨æ¨ç®—ï¼Œè¯·ç¨å€™...";
        out.innerHTML = `<div style='text-align:center; color:${getComputedStyle(document.documentElement).getPropertyValue('--accent-gold').trim()};'>ç¥æœºæ¨æ¼”ä¸­...</div>`;
        
        const prompt = `ä½ æ˜¯ä¸“ä¸šçš„å…­çˆ»å¤§å¸ˆã€‚é—®é¢˜ï¼š${state.data.q}ã€‚æ—¶é—´ï¼š${state.data.d}ã€‚æœ¬å¦ï¼š${state.data.g}ã€‚åŠ¨çˆ»ï¼š${state.data.m}ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¨ç®—å¹¶æ ¼å¼åŒ–è¾“å‡ºï¼š\n\n### 1. ç®€è¦åˆ†æ\n\n- å–ç”¨ç¥\n- ææ—ºè¡°\n\n### 2. å‰å‡¶æ–­è¯­\n\n- ç›´æ¥ç»™å‡ºç»“è®ºï¼ˆå‰/å‡¶/å¹³ï¼‰\n- è§£é‡Šä¸»å¦ä¸åŠ¨çˆ»å¯¹ç”¨ç¥çš„å½±å“ã€‚\n\n### 3. è¡ŒåŠ¨å»ºè®®\n\n- æä¾›é€šä¿—æ˜“æ‡‚ã€å…·æœ‰å“²ç†æ€§çš„è¡ŒåŠ¨æŒ‡å¯¼å’Œå»ºè®®ã€‚`;

        try {
            const res = await fetch(WORKER_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
            
            const data = await res.json();
            
            if(res.status !== 200) {
                 throw new Error(data.message || 'Workerè¿”å›é”™è¯¯ï¼Œè¯·æ£€æŸ¥Keyæ˜¯å¦æœ‰æ•ˆã€‚');
            }
            
            // æ¸²æŸ“ç»“æœ
            out.innerHTML = typeof marked !== 'undefined' ? marked.parse(data.choices[0].message.content) : data.choices[0].message.content;
            btn.style.display = 'none'; // è§£è¯»æˆåŠŸåéšè—æŒ‰é’®

        } catch(e) {
            out.innerHTML = `<div style="color:var(--action-red); font-weight:bold;">âŒ æ¨ç®—å¤±è´¥ï¼šè¯·æ£€æŸ¥ Worker åœ°å€æˆ– Key æ˜¯å¦æ­£ç¡®ã€‚é”™è¯¯ä¿¡æ¯ï¼š${e.message}</div>`;
            btn.innerText = "âŒ é‡æ–°è¯·æ±‚"; btn.disabled = false;
        }
    }

    // --- è¾…åŠ©å‡½æ•° (ç®€åŒ–ç‰ˆï¼Œç¡®ä¿ä¸æŠ¥é”™) ---
    function getGuaName(bits) {
        const n = ['å¤','éœ‡','å','å…‘','è‰®','ç¦»','å·½','ä¹¾'];
        const u = parseInt(bits.slice(3,6).reverse().join(''), 2);
        const l = parseInt(bits.slice(0,3).reverse().join(''), 2);
        const guaNames = ['å¤©', 'åœ°', 'æ°´', 'ç«', 'é›·', 'é£', 'å±±', 'æ³½'];
        // ç®€åŒ–å‘½åé€»è¾‘
        return { name: guaNames[u] + guaNames[l] + "å¦", palace: n[u] }; 
    }
    function getZhis(bits) {
        const n = ['å¤','éœ‡','å','å…‘','è‰®','ç¦»','å·½','ä¹¾'];
        const u = parseInt(bits.slice(3,6).reverse().join(''), 2);
        const l = parseInt(bits.slice(0,3).reverse().join(''), 2);
        return [...CFG.NA_JIA[n[l]].z.slice(0,3), ...CFG.NA_JIA[n[u]].z.slice(3,6)];
    }
    function getRel(me, other) { /* ... */ return "å…­äº²"; }
    function getBeasts(g) { /* ... */ return []; }

    // é¡µé¢åŠ è½½æ—¶å¯ç”¨æŒ‰é’®
    window.onload = function() {
        document.getElementById('tossBtn').disabled = false;
    };
</script>
</body>
</html>
