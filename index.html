<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç„æœºå…­çˆ» Â· Gemini Worker ç›´é€š</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- å…¨å±€å¤é£é›…éŸµä¸»é¢˜ --- */
        :root {
            --primary-ink: #2c3e50;    /* ç„å¢¨æ·± */
            --accent-gold: #c2995f;    /* é›…è‡´éé‡‘ */
            --highlight-red: #a52a2a;  /* å¤å…¸æœ±ç ‚çº¢ */
            --bg-paper: #f8f7f5;       /* å®£çº¸ç™½ */
            --border-light: #e0e0e0;   /* æ·¡æè¾¹ */
            --card-soft: #ffffff;
            --font-main: 'FangSong', 'KaiTi', 'SimSun', serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-paper);
            color: var(--primary-ink);
            margin: 0;
            padding: 30px 15px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            background: var(--card-soft);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }

        /* æ ‡é¢˜åŒº */
        header { text-align: center; margin-bottom: 30px; border-bottom: 1px dashed var(--border-light); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 2rem; letter-spacing: 4px; color: var(--primary-ink); font-weight: bold; }
        h1 span { color: var(--accent-gold); }
        .subtitle { font-size: 0.9rem; color: #888; margin-top: 8px; font-style: italic; }

        /* è¾“å…¥åŒº */
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; margin-bottom: 10px; font-size: 0.95rem; color: #555; text-align: center; }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            box-sizing: border-box;
            background: #fdfdfd;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus { border-color: var(--accent-gold); box-shadow: 0 0 5px rgba(194, 153, 95, 0.3); }

        /* æŒ‰é’®é£æ ¼ */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 1px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn-start { background: var(--highlight-red); color: white; }
        .btn-start:active { transform: translateY(1px); box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .btn-start:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        .btn-ai { background: var(--primary-ink); color: var(--accent-gold); margin-top: 15px; }
        .btn-restart { background: none; border: 1px solid var(--border-light); color: #888; margin-top: 25px; }

        /* æ‘‡å¦åŒº */
        .stage-area {
            min-height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 18px;
            margin: 25px 0;
            background: #fefefe;
            border-radius: 10px;
            border: 1px dashed var(--border-light);
            padding: 15px;
        }
        .coin {
            width: 48px; height: 48px;
            border-radius: 50%;
            border: 3px solid var(--accent-gold);
            background: #fdfdfd;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1rem; color: var(--primary-ink);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            animation: coinSpin 0.5s ease-out;
        }
        .coin.yin { background: var(--primary-ink); color: #fff; border-color: var(--primary-ink); }
        @keyframes coinSpin { from { transform: scale(0.8) rotateY(0deg); opacity: 0.5; } to { transform: scale(1) rotateY(360deg); opacity: 1; } }

        /* å†å²è®°å½• */
        .history-list { display: flex; flex-direction: column-reverse; gap: 6px; margin-top: 20px; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0;
            border-bottom: 1px dotted var(--border-light);
            font-size: 0.95rem;
        }
        .yao-symbol { font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.3rem; letter-spacing: -2px; color: var(--primary-ink); }
        .dong-mark { color: var(--highlight-red); margin-left: 5px; font-size: 1.1em; }

        /* ç»“æœä¸åˆ†äº«å¡ç‰‡ */
        #resultView { display: none; margin-top: 30px; }
        .result-card {
            padding: 25px;
            border-radius: 10px;
            background: linear-gradient(145deg, var(--card-soft), #fffaf0);
            border: 1px solid var(--accent-gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        .card-title { text-align: center; color: var(--highlight-red); font-size: 1.4rem; margin-bottom: 15px; }
        .meta-info { font-size: 0.9rem; color: #777; margin-bottom: 20px; line-height: 1.6; text-align: center; }

        /* AI è§£è¯»å†…å®¹ */
        .ai-content { 
            border-top: 1px dashed var(--border-light); 
            padding-top: 20px; 
            margin-top: 20px; 
            line-height: 1.8; 
            font-size: 0.98rem;
            color: var(--primary-ink);
        }
        .ai-content p { margin-bottom: 1em; }
        .ai-content strong { color: var(--primary-ink); }
        .ai-content h3 { 
            color: var(--highlight-red); 
            font-size: 1.1rem; 
            margin-top: 1.5em; 
            margin-bottom: 0.8em; 
            border-left: 3px solid var(--highlight-red); 
            padding-left: 10px;
        }
        
        .share-prompt { 
            text-align: center; 
            margin-top: 25px; 
            padding: 10px; 
            background: #e6f7e6;
            color: #388e3c; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>ç„æœº<span>å…­çˆ»</span></h1>
        <div class="subtitle">æ´å¯Ÿå¤©æœº Â· Gemini Worker ç›´é€š</div>
    </header>

    <div id="setupView">
        <div class="input-group">
            <label for="question">ğŸ™ è¯·è™”è¯šé»˜å¿µé—®é¢˜ï¼Œç„¶åè¾“å…¥ï¼š</label>
            <input type="text" id="question" placeholder="ä¾‹å¦‚ï¼šè¿‘æœŸè´¢è¿å¦‚ä½•ï¼Ÿäº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ">
        </div>

        <div class="stage-area" id="coinStage">
            <span style="color:#a0a0a0;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå¼€å§‹æ‘‡å¦...</span>
        </div>

        <button class="btn btn-start" id="tossBtn" onclick="userToss()">å¼€å§‹æ‘‡å¦ (1/6)</button>
        
        <div class="history-list" id="historyLog"></div>
    </div>

    <div id="resultView">
        <div class="result-card">
            <div class="card-title">âœ¨ ç¥æœºè§£è¯­ âœ¨</div>
            <div class="meta-info" id="cardMeta"></div>
            
            <div class="ai-content" id="aiOutput">
                <div style="text-align:center; color:#999;">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¯·æ±‚ AI è§£è¯»...</div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-ai" id="aiBtn" onclick="callGeminiAI()">ğŸ¤– è¯·æ±‚ AI å¤§å¸ˆè§£å¦</button>
                </div>
            </div>
            
            <div class="share-prompt">
                ï¼ˆé€šè¿‡ Cloudflare Worker ä»£ç†è®¿é—® Gemini APIï¼‰
            </div>
        </div>
        
        <div style="text-align:center;">
            <button class="btn btn-restart" onclick="location.reload()">é‡æ–°èµ·å¦</button>
        </div>
    </div>
</div>

<script>
    // --- Gemini API é…ç½® (å·²é›†æˆæ‚¨çš„ Worker URL) ---
    // âš ï¸ æ³¨æ„ï¼šAPI Key å·²å®‰å…¨åœ°å­˜å‚¨åœ¨æ‚¨çš„ Cloudflare Worker ç¯å¢ƒå˜é‡ä¸­ã€‚
    const GEMINI_ENDPOINT = "https://t6.tk709054540.workers.dev/"; 


    // --- æ ¸å¿ƒé…ç½® (ä¸å˜) ---
    const CFG = {
        NA_JIA: { 'ä¹¾': {z:['å­','å¯…','è¾°','åˆ','ç”³','æˆŒ']}, 'å¤': {z:['æœª','å·³','å¯','ä¸‘','äº¥','é…‰']}, 'éœ‡': {z:['å­','å¯…','è¾°','åˆ','ç”³','æˆŒ']}, 'å·½': {z:['ä¸‘','äº¥','é…‰','æœª','å·³','å¯']}, 'å': {z:['å¯…','è¾°','åˆ','ç”³','æˆŒ','å­']}, 'ç¦»': {z:['å¯','ä¸‘','äº¥','é…‰','æœª','å·³']}, 'è‰®': {z:['è¾°','åˆ','ç”³','æˆŒ','å­','å¯…']}, 'å…‘': {z:['å·³','å¯','ä¸‘','äº¥','é…‰','æœª']} },
        PALACE: {'ä¹¾':'é‡‘','å…‘':'é‡‘','ç¦»':'ç«','éœ‡':'æœ¨','å·½':'æœ¨','å':'æ°´','è‰®':'åœŸ','å¤':'åœŸ'},
        WUXING_REV: {'å­':'æ°´','äº¥':'æ°´','å¯…':'æœ¨','å¯':'æœ¨','å·³':'ç«','åˆ':'ç«','ç”³':'é‡‘','é…‰':'é‡‘','è¾°':'åœŸ','æˆŒ':'åœŸ','ä¸‘':'åœŸ','æœª':'åœŸ'},
        BEASTS: ['é’é¾™','æœ±é›€','å‹¾é™ˆ','æ»•è›‡','ç™½è™','ç„æ­¦']
    };

    let state = { count: 0, results: [], data: {} };
    
    // --- æ‘‡å¦å‡½æ•° (ä¸å˜) ---
    function userToss() {
        try {
            if(state.count >= 6) return;
            if(navigator.vibrate) navigator.vibrate(50); 

            let c = [Math.random()>.5?1:0, Math.random()>.5?1:0, Math.random()>.5?1:0];
            let sum = c[0]+c[1]+c[2];
            let val = sum===1?7 : sum===2?8 : sum===3?9 : 6;
            let name = sum===1?"å°‘é˜³": sum===2?"å°‘é˜´": sum===3?"è€é˜³(åŠ¨)":"è€é˜´(åŠ¨)";

            state.results.push(val);
            state.count++;

            document.getElementById('coinStage').innerHTML = c.map(y => `<div class="coin ${y?'yin':''}"></div>`).join('');
            
            let sym = (val===7||val===9)?"â”â”â”":"â”ã€€â”";
            let mk = (val===6||val===9)?"<span class='dong-mark'>â—</span>":"";
            let row = `<div class="history-item"><span>ç¬¬ ${state.count} çˆ» Â· ${name}</span><span class="yao-symbol">${sym} ${mk}</span></div>`;
            document.getElementById('historyLog').insertAdjacentHTML('afterbegin', row);

            let btn = document.getElementById('tossBtn');
            if(state.count < 6) { 
                btn.innerText = `ç»§ç»­æ‘‡å¦ (${state.count+1}/6)`; 
            } else { 
                btn.innerText = "æ­£åœ¨æ’ç›˜..."; 
                btn.disabled = true; 
                setTimeout(calculate, 600); 
            }
        } catch(e) {
            console.error("æ‘‡å¦åŠŸèƒ½å‡ºé”™:", e);
            alert("æ‘‡å¦åŠŸèƒ½å‡ºç°å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æ§åˆ¶å°ã€‚");
        }
    }

    // --- æ’ç›˜å‡½æ•° (ä¸å˜) ---
    function calculate() {
        document.getElementById('setupView').style.display = 'none';
        document.getElementById('resultView').style.display = 'block';

        let dateStr = "", gzDay = "ç”²å­", dayGan = "ç”²", xunKong = "æœªçŸ¥";
        try { 
            if(typeof Solar === 'undefined') throw new Error("Lunar.js library not loaded.");
            const d = Solar.fromDate(new Date()); const l = d.getLunar();
            dateStr = l.getYearInGanZhi() + "å¹´" + l.getMonthInGanZhi() + "æœˆ";
            gzDay = l.getDayInGanZhi(); dayGan = l.getDayInGanZhi()[0]; xunKong = l.getDayXunKong();
        } catch(e) { 
            console.warn("æ— æ³•åŠ è½½æ—¥å†åº“æˆ–è®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨é€šç”¨æ—¶é—´:", e);
            dateStr = (new Date()).toLocaleDateString('zh-CN');
        }

        const benBits = state.results.map(r=>(r===7||r===9)?1:0);
        const benInfo = getGuaName(benBits);
        const meEl = CFG.PALACE[benInfo.palace];

        const moves = state.results.map((v, i) => (v===6 || v===9) ? `${['åˆ','äºŒ','ä¸‰','å››','äº”','ä¸Š'][i]}çˆ»åŠ¨` : null).filter(Boolean);

        state.data = {
            q: document.getElementById('question').value || "æœªæŒ‡å®šé—®é¢˜", 
            d: dateStr + gzDay, 
            g: benInfo.name, 
            m: moves.join('ï¼›') || "é™å¦"
        };
        
        document.getElementById('cardMeta').innerHTML = `
            <strong>æ‰€é—®ï¼š</strong>${state.data.q}<br>
            <strong>æ—¥æœŸï¼š</strong>${dateStr} / ${gzDay} (${xunKong}ç©º)<br>
            <strong>å¦è±¡ï¼š</strong>${state.data.g} (å±${benInfo.palace}${meEl})
        `;
    }

    // --- AI è§£å¦å‡½æ•° (é€šè¿‡ Worker ä»£ç†è®¿é—®) ---
    async function callGeminiAI() {
        const btn = document.getElementById('aiBtn');
        const out = document.getElementById('aiOutput');
        
        btn.disabled = true;
        btn.innerText = "â³ AI æ­£åœ¨é€šè¿‡ä»£ç†æ¨ç®—ï¼Œè¯·ç¨å€™...";
        out.innerHTML = `<div style='text-align:center; color:${getComputedStyle(document.documentElement).getPropertyValue('--accent-gold').trim()};'>ç¥æœºæ¨æ¼”ä¸­ï¼Œè¯·ç¨å€™...</div>`;
        
        const prompt = `ä½ æ˜¯ä¸“ä¸šçš„å…­çˆ»å¤§å¸ˆã€‚é—®é¢˜ï¼š${state.data.q}ã€‚æ—¶é—´ï¼š${state.data.d}ã€‚æœ¬å¦ï¼š${state.data.g}ã€‚åŠ¨çˆ»ï¼š${state.data.m}ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¨ç®—å¹¶æ ¼å¼åŒ–è¾“å‡ºï¼š\n\n### 1. ç®€è¦åˆ†æ\n\n- å–ç”¨ç¥\n- ææ—ºè¡°\n\n### 2. å‰å‡¶æ–­è¯­\n\n- ç›´æ¥ç»™å‡ºç»“è®ºï¼ˆå‰/å‡¶/å¹³ï¼‰\n- è§£é‡Šä¸»å¦ä¸åŠ¨çˆ»å¯¹ç”¨ç¥çš„å½±å“ã€‚\n\n### 3. è¡ŒåŠ¨å»ºè®®\n\n- æä¾›é€šä¿—æ˜“æ‡‚ã€å…·æœ‰å“²ç†æ€§çš„è¡ŒåŠ¨æŒ‡å¯¼å’Œå»ºè®®ã€‚`;

        try {
            // è¯·æ±‚å‘é€åˆ° Worker Endpoint
            const res = await fetch(GEMINI_ENDPOINT, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                // Worker ä¼šå°† generationConfig è½¬å‘ç»™ Gemini API
                body: JSON.stringify({
                    contents: [{role: "user", parts: [{text: prompt}]}],
                    generationConfig: {temperature: 1.0} 
                })
            });
            
            const data = await res.json();
            
            if(res.status !== 200 || !data.candidates || data.candidates.length === 0) {
                 // Worker è¿”å›çš„é”™è¯¯æˆ– Gemini API çš„é”™è¯¯
                 throw new Error(data.error?.message || `ä»£ç†è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${res.status}`);
            }
            
            // è§£æ Gemini å“åº”
            const resultText = data.candidates[0].content.parts[0].text;
            
            out.innerHTML = typeof marked !== 'undefined' ? marked.parse(resultText) : resultText;
            btn.style.display = 'none';

        } catch(e) {
            out.innerHTML = `<div style="color:var(--highlight-red); font-weight:bold;">âŒ æ¨ç®—å¤±è´¥ï¼š${e.message}<br>è¯·æ£€æŸ¥ Worker URL æˆ–ä»£ç†æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚</div>`;
            btn.innerText = "âŒ é‡æ–°è¯·æ±‚"; btn.disabled = false;
            console.error("AIè§£å¦é”™è¯¯:", e);
        }
    }

    // --- è¾…åŠ©å‡½æ•° (ä¸å˜) ---
    function getGuaName(bits) {
        const n = ['å¤','éœ‡','å','å…‘','è‰®','ç¦»','å·½','ä¹¾'];
        const guaNames = ['å¤©', 'åœ°', 'æ°´', 'ç«', 'é›·', 'é£', 'å±±', 'æ³½'];
        const up = parseInt(bits.slice(3,6).reverse().join(''), 2);
        const low = parseInt(bits.slice(0,3).reverse().join(''), 2);
        return { name: guaNames[up] + guaNames[low] + "å¦", palace: n[up] }; 
    }
    function getZhis(bits) {
        const n = ['å¤','éœ‡','å','å…‘','è‰®','ç¦»','å·½','ä¹¾'];
        const up = parseInt(bits.slice(3,6).reverse().join(''), 2);
        const low = parseInt(bits.slice(0,3).reverse().join(''), 2);
        return [...CFG.NA_JIA[n[low]].z.slice(0,3), ...CFG.NA_JIA[n[up]].z.slice(3,6)];
    }
    function getRel(me, other) {
        if(me===other) return "å…„å¼Ÿ";
        const s = {é‡‘:'æ°´',æ°´:'æœ¨',æœ¨:'ç«',ç«:'åœŸ',åœŸ:'é‡‘'};
        const k = {é‡‘:'æœ¨',æœ¨:'åœŸ',åœŸ:'æ°´',æ°´:'ç«',ç«:'é‡‘'};
        if(s[me]===other) return "å­å­™"; if(s[other]===me) return "çˆ¶æ¯";
        if(k[me]===other) return "å¦»è´¢"; if(k[other]===me) return "å®˜é¬¼";
        return "æœªçŸ¥";
    }
    function getBeasts(g) {
        const m = {ç”²:0,ä¹™:0,ä¸™:1,ä¸:1,æˆŠ:2,å·±:3,åºš:4,è¾›:4,å£¬:5,ç™¸:5};
        const b = ['é’é¾™','æœ±é›€','å‹¾é™ˆ','æ»•è›‡','ç™½è™','ç„æ­¦'];
        return Array.from({length:6},(_,i)=>b[(m[g]||0+i)%6]);
    }

    window.onload = function() {
        document.getElementById('tossBtn').disabled = false;
    };
</script>
</body>
</html>
