<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ”® ç¥æœºå¦™ç®— Â· å¾®ä¿¡åˆ†äº«ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* CSS æ ·å¼ (åŒä¸Šæ–‡ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ï¼ŒåŠŸèƒ½éƒ¨åˆ†ä¿ç•™) */
        :root { --primary: #c0392b; --gold: #f39c12; --secondary: #34495e; --bg: #f7f7f7; }
        body { font-family: 'PingFang SC', 'Songti SC', serif; background: var(--bg); color: var(--secondary); padding: 20px 15px; line-height: 1.6; }
        .app-container { width: 100%; max-width: 600px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 20px; }
        h1 { text-align: center; color: var(--primary); margin: 0 0 20px; font-size: 1.8rem; letter-spacing: 2px; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #ddd; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .btn { padding: 15px; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-start { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.4); }
        .btn-ai { background: var(--secondary); color: var(--gold); margin-top: 15px; }
        .stage { height: 70px; display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; background: #fcfcfc; border-radius: 10px; }
        .coin { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--gold); }
        .row { padding: 8px 0; border-bottom: 1px dashed #eee; }
        .sym { font-family: monospace; font-size: 1.2rem; }
        #resultView { display: none; }
        .info-card { background: #fef9e8; padding: 12px; border-radius: 8px; margin-bottom: 20px; color: #7f6834; border-left: 4px solid var(--gold); }
        table { width: 100%; font-size: 0.85rem; }
        
        /* --- åˆ›æ„åˆ†äº«å¡ç‰‡æ ·å¼ --- */
        #shareCard { 
            display: none; 
            margin-top: 30px; 
            padding: 25px; 
            border-radius: 15px; 
            background: linear-gradient(145deg, #fff 0%, #fff0e0 100%);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 2px solid var(--gold);
        }
        .card-header { text-align: center; margin-bottom: 20px; }
        .card-header h2 { color: var(--primary); font-size: 1.6rem; margin: 0; }
        .card-meta { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .card-content { border-top: 1px dashed #ddd; padding-top: 20px; }
        .share-prompt { text-align: center; margin-top: 30px; padding: 15px; background: #e8f5e9; color: #388e3c; border-radius: 10px; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(56, 142, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(56, 142, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(56, 142, 60, 0); } }
    </style>
</head>
<body>

<div class="app-container">
    <h1>ğŸ”® ç¥æœºå¦™ç®— <span>å…­çˆ»</span></h1>
    
    <div id="setupView">
        <input type="text" id="question" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨æƒ³é—®çš„é—®é¢˜ï¼ˆå¦‚ï¼šè´¢è¿ã€äº‹ä¸šã€å§»ç¼˜ï¼‰">
        
        <div class="stage" id="coinStage"><span>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹</span></div>
        <button class="btn btn-start" id="tossBtn" onclick="userToss()">å¼€å§‹æ‘‡å¦ (1/6)</button>
        <div class="history" id="historyLog"></div>
    </div>

    <div id="resultView">
        <div class="info-card" id="baseInfo"></div>
        <table><thead><tr><th>å…­ç¥</th><th>æœ¬å¦</th><th>å˜å¦</th></tr></thead><tbody id="panBody"></tbody></table>
        
        <div style="text-align:center;"><button class="btn btn-ai" id="aiBtn" onclick="callDeepSeek()">ğŸ¤– è¯·æ±‚ AI å¤§å¸ˆè§£å¦</button></div>
    </div>

    <div id="shareCard">
        <div class="card-header">
            <h2>âœ¨ ã€ç¥æœºè§£è¯­ã€‘ âœ¨</h2>
            <div class="card-meta" id="cardMeta"></div>
        </div>
        <div class="card-content" id="cardContent">
            <div style="text-align:center; color:#999;">ç­‰å¾… AI ç»“æœ...</div>
        </div>
        <div class="share-prompt">
            é•¿æŒ‰å±å¹•ä¿å­˜å›¾ç‰‡ï¼Œå³å¯åˆ†äº«è‡³æœ‹å‹åœˆæˆ–å¥½å‹ï¼
        </div>
    </div>
    
    <div style="text-align:center; margin-top:20px;">
        <button onclick="location.reload()" style="background:none; border:none; color:#888; padding:10px;">ğŸ”„ é‡æ–°èµ·å¦</button>
    </div>
</div>

<script>
    // âš ï¸ å…³é”®è®¾ç½®ï¼šè¯·å°†æ­¤å ä½ç¬¦æ›¿æ¢ä¸ºæ‚¨å®é™…éƒ¨ç½²çš„ Cloudflare Worker URL
    const WORKER_ENDPOINT = "https://t6.tk709054540.workers.dev/"; 
    // ä¾‹å¦‚: "https://my-deepseek-proxy.workers.dev"

    // --- æ ¸å¿ƒé…ç½® ---
    const CFG = {
        NA_JIA: { 'ä¹¾': {z:['å­','å¯…','è¾°','åˆ','ç”³','æˆŒ']}, 'å¤': {z:['æœª','å·³','å¯','ä¸‘','äº¥','é…‰']}, 'éœ‡': {z:['å­','å¯…','è¾°','åˆ','ç”³','æˆŒ']}, 'å·½': {z:['ä¸‘','äº¥','é…‰','æœª','å·³','å¯']}, 'å': {z:['å¯…','è¾°','åˆ','ç”³','æˆŒ','å­']}, 'ç¦»': {z:['å¯','ä¸‘','äº¥','é…‰','æœª','å·³']}, 'è‰®': {z:['è¾°','åˆ','ç”³','æˆŒ','å­','å¯…']}, 'å…‘': {z:['å·³','å¯','ä¸‘','äº¥','é…‰','æœª']} },
        PALACE: {'ä¹¾':'é‡‘','å…‘':'é‡‘','ç¦»':'ç«','éœ‡':'æœ¨','å·½':'æœ¨','å':'æ°´','è‰®':'åœŸ','å¤':'åœŸ'},
        WUXING_REV: {'å­':'æ°´','äº¥':'æ°´','å¯…':'æœ¨','å¯':'æœ¨','å·³':'ç«','åˆ':'ç«','ç”³':'é‡‘','é…‰':'é‡‘','è¾°':'åœŸ','æˆŒ':'åœŸ','ä¸‘':'åœŸ','æœª':'åœŸ'},
        BEASTS: ['é’é¾™','æœ±é›€','å‹¾é™ˆ','æ»•è›‡','ç™½è™','ç„æ­¦']
    };

    let state = { count: 0, results: [], data: {} };

    // --- é€»è¾‘å‡½æ•° (æ‘‡å¦ã€æ’ç›˜ä»£ç ä¸ä¸Šæ–‡ä¿æŒä¸€è‡´ï¼Œå·²çœç•¥) ---
    function userToss() { /* ... æ‘‡å¦ä»£ç  ... */ }
    function calculate() { /* ... æ’ç›˜ä»£ç  ... */ }
    
    // --- å…³é”®ï¼šè°ƒç”¨ DeepSeek Worker Proxy ---
    async function callDeepSeek() {
        if (WORKER_ENDPOINT.includes("YOUR-WORKER-NAME")) {
             alert("é”™è¯¯ï¼šè¯·å…ˆéƒ¨ç½² Cloudflare Worker å¹¶æ›´æ–° WORKER_ENDPOINT åœ°å€ï¼");
             return;
        }

        const btn = document.getElementById('aiBtn');
        const out = document.getElementById('cardContent');
        
        btn.disabled = true;
        btn.innerText = "â³ AI æ­£åœ¨æ¨ç®—...";
        out.innerHTML = `<div style='text-align:center; color:#888;'>æ­£åœ¨è¿æ¥äº‘ç«¯ç¥æœº...</div>`;
        
        // æ„é€ å‘é€ç»™ Worker çš„ Prompt
        const prompt = `ä½ æ˜¯ä¸“ä¸šçš„å…­çˆ»å¤§å¸ˆã€‚é—®é¢˜ï¼š${state.data.q}ã€‚æ—¶é—´ï¼š${state.data.d}ã€‚æœ¬å¦ï¼š${state.data.g}ã€‚åŠ¨çˆ»ï¼š${state.data.m}ã€‚è¯·è¿›è¡Œä¸¥è°¨çš„ï¼š1.å–ç”¨ç¥ï¼›2.ææ—ºè¡°ï¼›3.æ–­å‰å‡¶ã€‚**æœ€åç»™å‡ºé€šä¿—æ˜“æ‡‚çš„æ€»ç»“å’Œå»ºè®®**ã€‚`;

        try {
            // è¯·æ±‚ Worker ä»£ç†
            const res = await fetch(WORKER_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt }) // åªå‘é€ Promptï¼ŒWorkerä¼šåŠ  Key
            });
            
            const data = await res.json();
            
            if(res.status !== 200) {
                 // å¤„ç†Workeræˆ–DeepSeekè¿”å›çš„é”™è¯¯
                 throw new Error(data.message || 'Workerè¿”å›é”™è¯¯ï¼Œè¯·æ£€æŸ¥Keyæ˜¯å¦æœ‰æ•ˆã€‚');
            }
            
            // æ¸²æŸ“ç»“æœåˆ°å¡ç‰‡
            out.innerHTML = typeof marked !== 'undefined' ? marked.parse(data.choices[0].message.content) : data.choices[0].message.content;
            btn.style.display = 'none'; 

        } catch(e) {
            out.innerHTML = `<div style="color:red; font-weight:bold;">âŒ è§£è¯»å¤±è´¥ï¼š${e.message}</div>`;
            btn.innerText = "âŒ é‡æ–°è¯·æ±‚"; btn.disabled = false;
        }
    }

    // --- è¾…åŠ©å‡½æ•° (ä¸ºä¿è¯åŠŸèƒ½å®Œæ•´ï¼Œè¯·ä¸è¦åˆ é™¤) ---
    function getGuaName(bits) { /* ... */ return { name: "å¦å", palace: "å®«" }; }
    function getZhis(bits) { /* ... */ return []; }
    function getRel(me, other) { /* ... */ return "å…­äº²"; }
    function getBeasts(g) { /* ... */ return []; }
    // ç¡®ä¿calculateå’ŒuserTosså‡½æ•°ä½“åœ¨æ­¤å¤„è¢«åŒ…å«ï¼ˆä¸ºç®€æ´å·²çœç•¥ï¼Œå®é™…æ–‡ä»¶ä¸­åº”å®Œæ•´ï¼‰
</script>
</body>
</html>